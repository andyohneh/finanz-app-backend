<!DOCTYPE html>
<html lang="de">
  <head> </head>
  <body>
    <div class="container">
      <main>
        <div class="table-container">
          <h2>Daily LSTM Strategie</h2>
          <div id="equity-chart-daily_lstm" class="equity-chart"></div>
          <table class="results-table">
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Gesamtrendite (%)</th>
                <th>Gewinnrate (%)</th>
                <th>Anzahl Trades</th>
              </tr>
            </thead>
            <tbody>
              {% for result in results.daily_lstm %}
              <tr>
                <td><strong>{{ result.Symbol }}</strong></td>
                <td
                  class="{% if result['Gesamtrendite_%'] > 0 %}positive{% else %}negative{% endif %}"
                >
                  {{ "%.2f"|format(result['Gesamtrendite_%']) }}%
                </td>
                <td>{{ "%.2f"|format(result['Gewinnrate_%']) }}%</td>
                <td>{{ result.Anzahl_Trades }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="table-container">
          <h2>Genius LSTM Strategie</h2>
          <div id="equity-chart-genius_lstm" class="equity-chart"></div>
          <table class="results-table">
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Gesamtrendite (%)</th>
                <th>Gewinnrate (%)</th>
                <th>Anzahl Trades</th>
              </tr>
            </thead>
            <tbody>
              {% for result in results.genius_lstm %}
              <tr>
                <td><strong>{{ result.Symbol }}</strong></td>
                <td
                  class="{% if result['Gesamtrendite_%'] > 0 %}positive{% else %}negative{% endif %}"
                >
                  {{ "%.2f"|format(result['Gesamtrendite_%']) }}%
                </td>
                <td>{{ "%.2f"|format(result['Gewinnrate_%']) }}%</td>
                <td>{{ result.Anzahl_Trades }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </main>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        function createEquityChart(elementId, seriesData) {
          const options = {
            series: seriesData,
            chart: {
              type: "area",
              height: 350,
              background: "transparent",
              toolbar: { show: true },
              zoom: { enabled: true },
            },
            theme: { mode: "dark" },
            dataLabels: { enabled: false },
            stroke: { curve: "smooth", width: 2 },
            xaxis: {
              type: "datetime",
              labels: { style: { colors: "#8e8e8e" } },
            },
            yaxis: {
              labels: {
                formatter: (value) => `€${(value || 0).toFixed(0)}`,
                style: { colors: "#8e8e8e" },
              },
            },
            tooltip: { theme: "dark", x: { format: "dd MMM yyyy" } },
            grid: { borderColor: "#535A6C" },
            legend: { position: "top", horizontalAlign: "center" },
          };
          const chart = new ApexCharts(
            document.querySelector(elementId),
            options
          );
          chart.render();
        }

        fetch("/api/equity-curves")
          .then((response) =>
            response.ok
              ? response.json()
              : Promise.reject("Equity-Daten konnten nicht geladen werden.")
          )
          .then((data) => {
            if (!data) return;
            for (const strategy in data) {
              // SICHERHEITS-CHECK: Nur fortfahren, wenn die Strategie-Daten existieren
              if (data[strategy] && Object.keys(data[strategy]).length > 0) {
                const elementId = `#equity-chart-${strategy}`;
                const series = [];
                for (const symbol in data[strategy]) {
                  const symbolData = data[strategy][symbol];
                  // SICHERHEITS-CHECK: Nur hinzufügen, wenn die Daten Arrays sind
                  if (
                    symbolData &&
                    Array.isArray(symbolData.dates) &&
                    Array.isArray(symbolData.values)
                  ) {
                    series.push({
                      name: symbol,
                      data: symbolData.dates.map((date, index) => [
                        new Date(date).getTime(),
                        symbolData.values[index],
                      ]),
                    });
                  }
                }
                if (document.querySelector(elementId) && series.length > 0) {
                  createEquityChart(elementId, series);
                }
              }
            }
          })
          .catch((error) =>
            console.error("Fehler beim Erstellen der Equity-Charts:", error)
          );
      });
    </script>
  </body>
</html>
