<!DOCTYPE html>
<html lang="de">
  <head> </head>
  <body>
    <script>
      const VAPID_PUBLIC_KEY = "DEIN_VAPID_PUBLIC_KEY_HIER_EINFÃœGEN"; // WICHTIG!

      function urlBase64ToUint8Array(base64String) {
        const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding)
          .replace(/-/g, "+")
          .replace(/_/g, "/");
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }

      async function subscribeUser() {
        try {
          const registration = await navigator.serviceWorker.ready;
          const subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
          });

          await fetch("/api/save-subscription", {
            method: "POST",
            body: JSON.stringify(subscription),
            headers: { "Content-Type": "application/json" },
          });
          alert("Push-Benachrichtigungen erfolgreich aktiviert!");
        } catch (error) {
          console.error("Fehler beim Abonnieren:", error);
          alert(
            "Fehler: Push-Benachrichtigungen konnten nicht aktiviert werden."
          );
        }
      }

      if ("serviceWorker" in navigator && "PushManager" in window) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("/sw.js").then((registration) => {
            console.log("Service Worker registriert.");
            document
              .getElementById("subscribe-button")
              .addEventListener("click", () => {
                Notification.requestPermission().then((permission) => {
                  if (permission === "granted") {
                    subscribeUser();
                  }
                });
              });
          });
        });
      }
    </script>
  </body>
</html>
