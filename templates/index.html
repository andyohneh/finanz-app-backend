<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Diamond Sky • KI-Handelssignale</title>
    <link
      rel="icon"
      href="{{ url_for('static', filename='favicon.ico') }}"
      type="image/x-icon"
    />
    <link
      rel="manifest"
      href="{{ url_for('static', filename='manifest.json') }}"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  </head>
  <body>
    <div class="container">
      <header class="header">
        <div class="logo">
          <img
            src="{{ url_for('static', filename='images/logo.png') }}"
            alt="Diamond Sky Logo"
          />
          <h1>Diamond Sky</h1>
        </div>
        <div class="header-actions">
          <a href="/dashboard" class="dashboard-link">Dashboard</a>
        </div>
      </header>

      <main>
        <div class="signal-cards-container"></div>
      </main>

      <div id="chart-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2 id="chart-asset-title">Chart</h2>
            <span class="close-button">&times;</span>
          </div>
          <div class="modal-body">
            <div id="chart-container" style="height: 400px"></div>
          </div>
        </div>
      </div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const signalCardsContainer = document.querySelector(
          ".signal-cards-container"
        );
        const modal = document.getElementById("chart-modal");
        const closeModal = document.querySelector(".close-button");
        const chartContainer = document.getElementById("chart-container");
        const chartAssetTitle = document.getElementById("chart-asset-title");

        // Diese Variable wird die Chart-Instanz halten.
        // Wichtig: Sie wird nur hier deklariert.
        let chart = null;

        // ----- Live-Signale laden -----
        function fetchSignalData() {
          fetch("/api/assets")
            .then((response) => {
              if (!response.ok)
                throw new Error(`HTTP-Fehler! Status: ${response.status}`);
              return response.json();
            })
            .then((data) => {
              signalCardsContainer.innerHTML = ""; // Leeren für Refresh
              data.forEach((asset) => {
                const card = document.createElement("div");
                card.className = `signal-card ${asset.color}`;
                card.innerHTML = `
                            <div class="card-header">
                                <span class="asset-name">${asset.asset}</span>
                                <span class="material-icons icon">${asset.icon}</span>
                            </div>
                            <div class="card-body">
                                <div class="trade-info"><strong>Signal:</strong> ${asset.signal}</div>
                                <div class="trade-info"><strong>Einstieg:</strong> ${asset.entry}</div>
                                <div class="trade-info"><strong>Take Profit:</strong> ${asset.takeProfit}</div>
                                <div class="trade-info"><strong>Stop Loss:</strong> ${asset.stopLoss}</div>
                            </div>
                            <div class="card-footer">
                                <small>Letztes Update: ${asset.timestamp}</small>
                            </div>
                        `;
                // Event Listener, um das Chart-Modal zu öffnen
                card.addEventListener("click", () =>
                  openChartModal(asset.asset)
                );
                signalCardsContainer.appendChild(card);
              });
            })
            .catch((error) => {
              console.error("Fehler beim Laden der Signaldaten:", error);
              signalCardsContainer.innerHTML =
                '<p class="error-msg">Signale konnten nicht geladen werden.</p>';
            });
        }

        // Funktion, um den Chart im Modal zu öffnen und Daten zu laden
        function openChartModal(symbol) {
          chartAssetTitle.textContent = `${symbol} Chart (Täglich)`;
          modal.style.display = "block";

          // Bestehenden Chart sicher entfernen, falls das Modal erneut geöffnet wird
          if (chart) {
            chart.remove();
            chart = null;
          }

          // Lade-Spinner anzeigen
          chartContainer.innerHTML = '<div class="loader"></div>';

          fetch(`/historical-data/${symbol}`)
            .then((response) => {
              if (!response.ok)
                throw new Error("Netzwerkantwort war nicht ok.");
              return response.json();
            })
            .then((data) => {
              chartContainer.innerHTML = ""; // Lade-Spinner entfernen
              if (!data || data.length === 0 || data.error) {
                chartContainer.innerHTML =
                  '<p class="error-msg">Keine Chart-Daten verfügbar.</p>';
                return;
              }

              // Erstelle den Chart hier und weise ihn der 'chart'-Variable zu
              chart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.clientWidth,
                height: 400,
                layout: { backgroundColor: "#1E1E1E", textColor: "#D1D4DC" },
                grid: {
                  vertLines: { color: "#333" },
                  horzLines: { color: "#333" },
                },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                rightPriceScale: { borderColor: "#444" },
                timeScale: { borderColor: "#444" },
              });

              // Füge die Candlestick-Serie hinzu
              const candlestickSeries = chart.addCandlestickSeries({
                upColor: "#26a69a",
                downColor: "#ef5350",
                borderDownColor: "#ef5350",
                borderUpColor: "#26a69a",
                wickDownColor: "#ef5350",
                wickUpColor: "#26a69a",
              });

              candlestickSeries.setData(data);
              chart.timeScale().fitContent();
            })
            .catch((error) => {
              console.error("Fehler beim Laden der Chart-Daten:", error);
              chartContainer.innerHTML =
                '<p class="error-msg">Chart konnte nicht geladen werden.</p>';
            });
        }

        // --- Event Listeners ---

        // Modal-Schließ-Logik
        closeModal.onclick = () => {
          modal.style.display = "none";
        };
        window.onclick = (event) => {
          if (event.target == modal) modal.style.display = "none";
        };

        // Event Listener für Fenstergrößenänderung, um den Chart anzupassen
        window.addEventListener("resize", () => {
          if (chart && chartContainer.clientWidth > 0) {
            chart.resize(chartContainer.clientWidth, 400);
          }
        });

        // Initiale Daten laden und dann alle 60 Sekunden aktualisieren
        fetchSignalData();
        setInterval(fetchSignalData, 60000);
      });
    </script>
  </body>
</html>
